machine:
  node:
    version: 6.10.3
  environment:
    NODE_ENV: development
    YARN_VERSION: 0.23.4
    PATH: "${PATH}:${HOME}/.yarn/bin:${HOME}/${CIRCLE_PROJECT_REPONAME}/node_modules/.bin"
    ERROR_SCREENSHOT_DIR: /home/ubuntu/CPDBv2_frontend/errorShots
  post:
    - sudo add-apt-repository -y ppa:ubuntu-toolchain-r/test && sudo apt-get update && sudo apt-get install gcc-4.9 g++-4.9
dependencies:
  pre:
    - |
      if [[ ! -e ~/.yarn/bin/yarn || $(yarn --version) != "${YARN_VERSION}" ]]; then
        curl -o- -L https://yarnpkg.com/install.sh | bash -s -- --version $YARN_VERSION
      fi
    - curl -L -o google-chrome.deb https://dl.google.com/linux/direct/google-chrome-stable_current_amd64.deb
    - sudo apt-get install lsb-base
    - sudo dpkg -i google-chrome.deb || true
    - sudo apt-get -f install #resolves missing dependencies
    - sudo dpkg -i google-chrome.deb
    - sudo sed -i 's|HERE/chrome\"|HERE/chrome\" --disable-setuid-sandbox|g' /opt/google/chrome/google-chrome
    - rm google-chrome.deb
    - bash ./bin/install_phantomjs.sh
  override:
    - yarn install
  cache_directories:
    - "node_modules"
    - ~/.yarn
    - ~/.cache/yarn
test:
  override:
    - yarn lint
    - yarn cover-circle
    - yarn live-test
  post:
    - cat lcov.info | ./node_modules/coveralls/bin/coveralls.js
    # copy screenshot folder to artifact
    - if [ -d $ERROR_SCREENSHOT_DIR ]; then cp -r $ERROR_SCREENSHOT_DIR $CIRCLE_ARTIFACTS; fi

deployment:
  staging:
    branch: staging
    commands:
      - sudo pip install ansible
      - sudo ansible-galaxy install Heroqu.nodejs4x
      - sudo ansible-galaxy install nicolai86.phantomjs
      - sudo chown ubuntu ~/.ansible/ -R
      - bin/circle-deploy-staging
